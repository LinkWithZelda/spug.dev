---
id: deploy-config
title: 发布配置
---

## 介绍
配置指定应用在某环境下如何执行发布，发布支持两种方式 `常规发布` 和 `自定义发布`。

## 常规发布
由 `Spug` 负责应用代码的打包、传输和更新，但提供了各个阶段可自定义的钩子。
> 常规发布参考了开源项目 [瓦力](https://github.com/meolu/walle-web) 的一些设计思路，在此感谢。
> 如果你使用过 `瓦力` 的发布，可以直接迁移至常规发布。

### 配置项
- ***发布环境*** 为哪个环境创建的发布配置，例如：测试环境 / 生产环境等。
- ***Git仓库地址*** 该应用的 Git 仓库地址（请确保部署运维平台的服务器有权限通过给定的地址克隆仓库）。
- ***发布审核*** 开启后创建的发布申请单需要审核后才可以进行发布。
- ***目标主机部署路径*** 应用部署的路径，例如：静态网站部署在目标服务器的 `/var/www/html`。
- ***目标主机仓库路径*** 用于存储应用的历史版本，可自定义任意目录，例如：`/data/spug/repos`。
- ***保留历史版本数量*** 即如上边的例子中 `/data/spug/repos` 保留的历史版本数量，超过后早起的版本会自动删除，以节约存储空间。
- ***发布目标主机*** 可以选择一个或多个主机进行发布。
- ***文件过滤*** 可选 `仅包含` 或 `排除` 指定的文件，会从克隆的 Git 仓库的源代码中根据指定的规则过滤出符合条件的文件进行发布。
- ***自定义全局变量*** 可在后边的钩子命令内使用，Spug 本身也包含一些内置全局变量，请参考下文。
- ***代码迁出前执行*** 执行对象为部署运维平台的服务器，可以执行任意自定义命令。
- ***代码迁出后执行*** 执行对象为部署运维平台的服务器，当前目录为检出后的待发布的源代码目录，可执行任意自定义命令。
- ***应用发布前执行*** 执行对象为应用发布的目标主机，当前目录为待发布的源代码目录，可执行任意自定义命令。
- ***应用发布后执行*** 执行对象为应用发布的目标主机，当前目录为已发布的应用目录，可执行任意自定义命令。
> [使用 `nohup` 或 `&` 启动后台进程页面一直在转圈不会结束？](/docs/install-error#使用-nohup-启动后台进程页面一直在转圈不会结束？)

## 自定义发布
该发布模式下 Spug 仅负责按顺序依次执行记录的动作。

### 配置项
- ***发布环境*** 为哪个环境创建的发布配置，例如：测试环境 / 生产环境等。
- ***发布审核*** 开启后创建的发布申请单需要审核后才可以进行发布。
- ***发布目标主机*** 可以选择一个或多个主机进行发布。
- ***本地执行动作*** 可以添加多个执行动作，执行对象为部署运维平台的服务器，会优先按顺序执行本地动作。
- ***目标主机执行动作*** 可以添加多个执行动作，执行对象为发布的目标主机，按顺序依次执行。
> [使用 `nohup` 或 `&` 启动后台进程页面一直在转圈不会结束？](/docs/install-error#使用-nohup-启动后台进程页面一直在转圈不会结束？)

## 全局变量
- `SPUG_APP_NAME` 发布应用的名称
- `SPUG_APP_ID` 发布应用的 ID
- `SPUG_REQUEST_NAME` 发布申请单的名称
- `SPUG_REQUEST_ID` 发布申请单 ID
- `SPUG_ENV_ID` 发布环境 ID
- `SPUG_ENV_KEY` 发布环境的Key
- `SPUG_VERSION` 发布内部版本
- `SPUG_DEPLOY_ID` 发布配置 ID（v2.2.3新增）
- `SPUG_DEPLOY_TYPE` 发布类型（"1" 为正常发布，"2" 为回滚）
- `SPUG_API_TOKEN` 访问配置中心获取配置的 `API_TOKEN`
以下变量仅当在主机执行时有效
- `SPUG_HOST_ID` 当前执行主机的 ID（v2.2.3新增）
- `SPUG_HOST_NAME` 当前执行主机的 IP /域名（v2.2.3新增）
- `SPUG_GIT_BRANCH` 本次发布选择的 Git 分支（v2.3.2新增，常规发布基于分支时有效）
- `SPUG_GIT_COMMIT_ID` 本次发布选择的Git Commit ID（v2.3.2新增，常规发布基于分支时有效）
- `SPUG_GIT_TAG` 本次发布的Git Tag（v2.3.2新增，常规发布基于Tag时有效）
- `SPUG_REPOS_DIR` 常规发布源码存储目录（v2.3.4新增，`$SPUG_REPOS_DIR/$SPUG_DEPLOY_ID` 即为本次发布应用的源码目录）
